# Changelog

Почти все изменения проекта будут документироваться в этом файле.

## [1.1.0] - 01-08-2026

### Added
- Самообновление скрипта через модуль `updater.py`: проверка новых версий через GitHub API (releases/latest) с fallback на raw-файл `VERSION`.
- Staged-обновления `.new` + маркер `update.pending` и автоприменение обновлений при старте через `apply_pending_update_if_any()`.
- Новые ключи конфига (через `DEFAULTCONFIG`): `autoupdate`, `repo_owner`, `repo_name`, `repo_branch`.
- Авто-установка ядра Xray через модуль `xray_installer.py`: определение OS/архитектуры, скачивание релиза Xray-core, распаковка в `./bin`, выставление executable permissions, перенос `geoip.dat/geosite.dat` при наличии.
- Новые ключи конфига для ядра: `autoinstall_xray`, `xray_version` (поддержка `latest` или конкретного тега).
- CLI флаг `--no-update` для пропуска проверки обновлений при запуске.

### Changed
- Стартовый пайплайн: скрипт теперь применяет staged-апдейты до основной логики и выполняет проверку обновлений на старте (если модуль `updater` доступен).
- Детект ядра: если `xray/v2ray` не найден, скрипт пытается автоматически установить Xray и обновить `corepath` в `config.json`.

### Fixed
- Уменьшены ручные шаги при первом запуске на “чистой” машине: при отсутствии ядра предлагается (или выполняется) установка, вместо немедленного выхода с ошибкой.

## [1.0.3] - 01-05-2026

### Added
- Улучшенная нормализация URL в `cleanurl()` с поддержкой HTML entities и URL-encoding (кейсы `&amp;`, `&amp%3B`, `%26amp%3B`).
- CLI флаг `--self-test` для проверки корректности парсинга URL/параметров через `parse_qs()`.
- CLI флаг `--debug` (режим точечного дебага: `proxies_per_batch=1`, `threads=1`).
- Автосохранение артефактов падения батча: `savefailedbatch()` складывает `batch*.json` и `.log.txt` в `./failed_batches` и печатает команду воспроизведения `xray run -test -c ...`.
- Whitelist для Shadowsocks (AEAD-only) и фильтрация ссылок с неподдерживаемыми шифрами, чтобы не ломать запуск Xray. 

### Changed
- Запуск core (`runcore()`): вывод процесса теперь собирается через `stdout=PIPE` и `stderr=STDOUT` вместо глушения stdout.
- Логирование в batch-конфигах: `loglevel` повышен с `none` до `warning` для более информативных ошибок Xray.
- Обработка ошибок старта ядра в `Checker()`: вывод ошибки читается из объединённого потока/через `communicate()`, что снижает случаи `Unknown error`.
- Валидация VLESS REALITY: `pbk` проверяется через base64url-декод (строго 32 байта), `sid` нормализуется/валидируется как hex (чинится нечётная длина), `flow` отбрасывается если `security` не `tls/reality`.

### Fixed
- Исправлен баг, из-за которого параметры `security/pbk/sid/flow/type` не парсились при HTML/URL-экранировании, что приводило к генерации невалидных конфигов.
- Исправлены падения Xray с `Exit: 23`, вызванные невалидными REALITY `pbk` (теперь такие ссылки отбрасываются до генерации outbound).
- Исправлены падения Xray с `Exit: 23` на Shadowsocks из-за устаревших/неподдерживаемых cipher’ов (теперь такие SS-ссылки фильтруются).

## [] - 00-00-0000

### Added

### Changed

### Fixed